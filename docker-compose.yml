services:
  openclaw:
    build:
      context: .
      dockerfile: Dockerfile
    # Or use pre-built image:
    # image: ghcr.io/waterlou/openclaw:latest

    container_name: openclaw-nas
    restart: unless-stopped

    # Ports:
    # - 18789: OpenClaw gateway
    # - 5900: VNC direct access
    # - 6901: noVNC web interface (remote browser)
    # - 9222: Chrome DevTools Protocol (CDP)
    ports:
      - "18789:18789"
      - "5900:5900"
      - "6901:6901"
      # - "9222:9222"  # Uncomment for CDP access

    # Environment variables
    environment:
      # AI Provider (set your API key)
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}

      # Gateway configuration
      OPENCLAW_GATEWAY_BIND: lan

      # Browser configuration
      PLAYWRIGHT_BROWSERS_PATH: /home/node/.cache/ms-playwright

      # Remote access configuration
      VNC_PASSWORD: ${VNC_PASSWORD:-openclaw}
      SCREEN_WIDTH: 1920
      SCREEN_HEIGHT: 1080

      # Browserless connection (for OpenClaw browser tool)
      # BROWSER_CDP_URL: http://browserless:3000

    # Persist state and workspace
    volumes:
      - openclaw-data:/home/node/.openclaw
      - openclaw-workspace:/home/node/workspace
      - openclaw-browser-cache:/home/node/.cache/ms-playwright

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:18789/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

    # Link to browserless service
    depends_on:
      - browserless

  # Browserless Chrome - Headless browser service for OpenClaw
  browserless:
    image: browserless/chrome:latest
    container_name: browserless
    restart: unless-stopped

    ports:
      - "3000:3000"   # Web interface and API

    environment:
      # Connection token (optional, for security)
      TOKEN: ${BROWSERLESS_TOKEN:-}

      # Maximum concurrent sessions
      MAX_CONCURRENT_SESSIONS: 10

      # Connection timeout (ms)
      CONNECTION_TIMEOUT: 600000

      # Maximum queue length
      MAX_QUEUE_LENGTH: 20

      # Preboot chrome for faster connections
      PREBOOT_CHROME: "true"

      # Enable debugging
      ENABLE_DEBUGGER: "true"

      # Keep alive
      KEEP_ALIVE: "true"

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  openclaw-data:
    name: openclaw-data
  openclaw-workspace:
    name: openclaw-workspace
  openclaw-browser-cache:
    name: openclaw-browser-cache
